```{r}

library(lubridate)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(ggrepel)
library(maps)

acc <- read.csv("https://raw.githubusercontent.com/xdaiISU/ds202materials/master/hwlabs/fars2017/accident.csv", stringsAsFactors = FALSE)

person <- read.csv("https://raw.githubusercontent.com/xdaiISU/ds202materials/master/hwlabs/fars2017/person.csv", stringsAsFactors = FALSE)

str(person)
```


## 4.
Create a map, and label each state with the most dangerous vehicle. Discuss the definition of the most dangerous vehicle, and what you find from the map. (Hint: Read the description for the STATE and COUNTY columns in the FARS manual. The state & county codes are Geographic Locator Codes (GLCs) from the General Services Administrationâ€™s (GSA) publication. Use readxl::read_xlsx to read in the GLCs.)

```{r}
StateCode <-readxl::read_xlsx('./data/state_codes.xlsx')
str(StateCode)
StateCode$'State Name'<- tolower(StateCode$'State Name')
StateCode$'City Code'  <- as.numeric(StateCode$'City Code')
StateCode$'County Code'  <- as.numeric(StateCode$'County Code')

states <- map_data("state")
labelPosition <- states %>%
   group_by(region) %>%
   summarise(long= mean(long, na.rm = TRUE), lat= mean(lat, na.rm = TRUE))
labelPosition <- left_join(labelPosition, StateCode, by = c("region" = "State Name"))
 head(labelPosition, 10)
# labelPosition <- left_join(labelPosition, dangerous, by = c("Codes" = "STATE"))
# labelPosition <- left_join(labelPosition, MakeCode, by = c("MAKE" = "Codes"))
                          
states %>% ggplot() +
  geom_polygon(  aes(x=long, y=lat, group=group),
                color="black", fill="lightblue" ) + geom_text(data=labelPosition, aes(label = Make, x=long, y=lat), size=3)
```

Analysis: It appears that the most dangerous make in the united states is Ford. That is the make that appears the most when looking at the total amount of fatal crashes.Following closely behind is Chevrolet, the next highest amount of fatal crashes.


## 5. 
Join the accident and person table (work out which variable(s) to use)
```{r}
q5 <- inner_join(person, acc, by="ST_CASE")
```

  The given documentation describes that ST_CASE is the shared variable for merging between accident and person.
  
  
## 6. 
Tally the number of accidents by day of the week (DAY_WEEK), hour of the day (HOUR) and gender (SEX). Visualize the results.
```{r}
withAvgSex <- joined %>%
  filter(SEX == 1 || SEX == 2) %>%
  group_by(ST_CASE) %>%
  summarise(avgSex = mean(SEX))
withAvgSex$sexesExplained <- ifelse(withAvgSex$avgSex == 1, 'Men Only', ifelse(withAvgSex$avgSex == 2, 'Women Only', 'Men and Women'))
accident <- withAvgSex %>%
  select(ST_CASE, sexesExplained) %>%
  inner_join( acc, by='ST_CASE')
grouped <- accident %>%
  filter(HOUR <= 24) %>%
  filter(DAY_WEEK != 9) %>%
  group_by(sexesExplained, HOUR, DAY_WEEK) %>%
  summarise(numAccidents = n()) %>%
  arrange(desc(numAccidents))
head(grouped, 10)
```

  From this table we begin to understand that the weekends have the most accidents, especially later at night.
  
```{r}
ggplot(grouped,aes(x=HOUR, y=numAccidents)) + geom_bar(stat='identity') + facet_grid(sexesExplained~DAY_WEEK)+xlab("Number of accidents")+ylab("Hour of day")
```